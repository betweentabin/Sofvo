<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tournament API Test</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    .test-section {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    input, select {
      padding: 8px;
      margin: 5px;
      width: 300px;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>ğŸ† Tournament API ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</h1>

  <!-- Auth Section -->
  <div class="test-section">
    <h2>èªè¨¼æƒ…å ±</h2>
    <div>
      <label>JWT Token: <input type="text" id="jwt" placeholder="JWT token from localStorage"></label>
      <button onclick="loadJWT()">LocalStorageã‹ã‚‰å–å¾—</button>
    </div>
    <div>
      <label>User ID: <input type="text" id="userId" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID"></label>
    </div>
  </div>

  <!-- Test 1: Get My Teams -->
  <div class="test-section">
    <h2>ãƒ†ã‚¹ãƒˆ1: æ‰€å±ãƒãƒ¼ãƒ ä¸€è¦§å–å¾—</h2>
    <button onclick="getMyTeams()">å®Ÿè¡Œ</button>
    <div id="teams-result"></div>
  </div>

  <!-- Test 2: Apply to Tournament -->
  <div class="test-section">
    <h2>ãƒ†ã‚¹ãƒˆ2: å¤§ä¼šã«å‚åŠ </h2>
    <div>
      <label>Tournament ID: <input type="text" id="tournamentId"></label>
    </div>
    <div>
      <label>Team ID: <input type="text" id="teamId"></label>
    </div>
    <button onclick="applyToTournament()">ãƒãƒ¼ãƒ ã§å‚åŠ </button>
    <div id="apply-result"></div>
  </div>

  <!-- Test 3: Get Tournament Matches -->
  <div class="test-section">
    <h2>ãƒ†ã‚¹ãƒˆ3: å¯¾æˆ¦è¡¨å–å¾—</h2>
    <div>
      <label>Tournament ID: <input type="text" id="matchesTournamentId"></label>
    </div>
    <button onclick="getTournamentMatches()">å–å¾—</button>
    <div id="matches-result"></div>
  </div>

  <!-- Test 4: Get Notifications -->
  <div class="test-section">
    <h2>ãƒ†ã‚¹ãƒˆ4: é€šçŸ¥ä¸€è¦§å–å¾—</h2>
    <button onclick="getNotifications()">å–å¾—</button>
    <div id="notifications-result"></div>
  </div>

  <!-- Test 5: Auto Generate Matches -->
  <div class="test-section">
    <h2>ãƒ†ã‚¹ãƒˆ5: ç· åˆ‡æ—¥ãƒãƒƒãƒå‡¦ç†</h2>
    <button onclick="autoGenerateMatches()">å®Ÿè¡Œ</button>
    <div id="batch-result"></div>
  </div>

  <script>
    const API_BASE = '/api';

    function loadJWT() {
      const jwt = localStorage.getItem('JWT');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      document.getElementById('jwt').value = jwt || '';
      document.getElementById('userId').value = user.id || '';
      alert('JWT ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
    }

    function getHeaders() {
      const jwt = document.getElementById('jwt').value;
      return {
        'Authorization': `Bearer ${jwt}`,
        'Content-Type': 'application/json'
      };
    }

    async function getMyTeams() {
      const userId = document.getElementById('userId').value;
      if (!userId) {
        alert('User IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/railway-teams/my-teams?user_id=${userId}`, {
          headers: getHeaders()
        });
        const data = await response.json();

        const resultDiv = document.getElementById('teams-result');
        resultDiv.innerHTML = `
          <h3 class="success">âœ… æˆåŠŸ</h3>
          <p>ãƒãƒ¼ãƒ æ•°: ${data.length}</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('teams-result').innerHTML = `
          <h3 class="error">âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <pre>${error.message}</pre>
        `;
      }
    }

    async function applyToTournament() {
      const tournamentId = document.getElementById('tournamentId').value;
      const teamId = document.getElementById('teamId').value;

      if (!tournamentId || !teamId) {
        alert('Tournament ID ã¨ Team ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/railway-tournaments/${tournamentId}/apply`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({
            mode: 'team',
            team_id: teamId
          })
        });
        const data = await response.json();

        const resultDiv = document.getElementById('apply-result');
        resultDiv.innerHTML = `
          <h3 class="${response.ok ? 'success' : 'error'}">${response.ok ? 'âœ… æˆåŠŸ' : 'âŒ ã‚¨ãƒ©ãƒ¼'}</h3>
          <p>å¯¾æˆ¦è¡¨è‡ªå‹•ç”Ÿæˆ: ${data.matches_generated ? 'ã¯ã„' : 'ã„ã„ãˆ'}</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('apply-result').innerHTML = `
          <h3 class="error">âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <pre>${error.message}</pre>
        `;
      }
    }

    async function getTournamentMatches() {
      const tournamentId = document.getElementById('matchesTournamentId').value;

      if (!tournamentId) {
        alert('Tournament ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/railway-tournaments/${tournamentId}/matches`, {
          headers: getHeaders()
        });
        const data = await response.json();

        const resultDiv = document.getElementById('matches-result');
        let matchList = '';
        data.forEach(match => {
          matchList += `
            <div style="border-bottom: 1px solid #eee; padding: 5px 0;">
              è©¦åˆ${match.match_number}: ${match.team1_name || 'æœªå®š'} vs ${match.team2_name || 'æœªå®š'}
            </div>
          `;
        });

        resultDiv.innerHTML = `
          <h3 class="success">âœ… æˆåŠŸ</h3>
          <p>è©¦åˆæ•°: ${data.length}</p>
          ${matchList}
          <details>
            <summary>è©³ç´°ãƒ‡ãƒ¼ã‚¿</summary>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </details>
        `;
      } catch (error) {
        document.getElementById('matches-result').innerHTML = `
          <h3 class="error">âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <pre>${error.message}</pre>
        `;
      }
    }

    async function getNotifications() {
      try {
        const response = await fetch(`${API_BASE}/railway-notifications`, {
          headers: getHeaders()
        });
        const data = await response.json();

        const resultDiv = document.getElementById('notifications-result');
        let notificationList = '';
        data.forEach(n => {
          const date = new Date(n.created_at);
          notificationList += `
            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px;">
              <strong>${n.type}</strong> - ${n.title || 'ç„¡é¡Œ'}
              <br>
              <small>ä½œæˆæ—¥æ™‚: ${date.toLocaleString('ja-JP')}</small>
              <br>
              ${n.content || n.message || ''}
            </div>
          `;
        });

        resultDiv.innerHTML = `
          <h3 class="success">âœ… æˆåŠŸ</h3>
          <p>é€šçŸ¥æ•°: ${data.length}</p>
          ${notificationList}
        `;
      } catch (error) {
        document.getElementById('notifications-result').innerHTML = `
          <h3 class="error">âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <pre>${error.message}</pre>
        `;
      }
    }

    async function autoGenerateMatches() {
      try {
        const response = await fetch(`${API_BASE}/railway-tournaments/auto-generate-matches`, {
          method: 'POST',
          headers: getHeaders()
        });
        const data = await response.json();

        const resultDiv = document.getElementById('batch-result');
        resultDiv.innerHTML = `
          <h3 class="success">âœ… æˆåŠŸ</h3>
          <p>å‡¦ç†ã—ãŸå¤§ä¼šæ•°: ${data.processed}</p>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        document.getElementById('batch-result').innerHTML = `
          <h3 class="error">âŒ ã‚¨ãƒ©ãƒ¼</h3>
          <pre>${error.message}</pre>
        `;
      }
    }
  </script>
</body>
</html>
